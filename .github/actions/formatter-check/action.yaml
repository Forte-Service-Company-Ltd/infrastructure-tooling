name: Checks formatting using language-appropriate tooling
description: If formatting changes are needed, this action will fail and provide a diff of the required changes. This can be used as a PR check.
inputs:
  formatter:
    description: The formatter to use. If not provided, the action will attempt to auto-detect based on the presence of configuration files.
    required: false
    default: auto
  path:
    description: Comma-separated list of files or directories to format (e.g. "src,tests,docs"). If not provided, defaults to the entire repository.
    required: false
    default: .
  config-file:
    description: Path to the Prettier configuration file. If not provided, Prettier's default settings will be used.
    required: false
runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Determine formatter tool
      id: determine-formatter
      shell: bash
      run: |
        echo "::group::Determining formatter"
        # Autodetect
        if [ "${{ inputs.formatter }}" != "auto" ]; then
          formatter="${{ inputs.formatter }}"
        # Prettier
        elif [ -f ".prettierrc" ] || [ -f ".prettierrc.json" ] || [ -f "prettier.config.js" ] || [ -f "package.json" ]; then
          formatter="prettier"
        # Foundry
        elif [ -f "foundry.toml" ]; then
          formatter="forge"
        # Python (Black)
        elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
          formatter="black"
        # Go (gofmt)
        elif [ -f "go.mod" ]; then
          formatter="gofmt"
        else
          formatter="none"
          echo "::error::No formatter could be determined. Please specify a formatter using the 'formatter' input."
          exit 1
        fi
        echo "::endgroup::"
        echo "formatter=$formatter" >> $GITHUB_OUTPUT
        echo "Using formatter: $formatter"

    - name: Install Prettier
      if: ${{ steps.determine-formatter.outputs.formatter == 'prettier' }}
      shell: bash
      run: |
        echo "Installing Prettier"
        npm install -g prettier

    - name: Install Black
      if: ${{ steps.determine-formatter.outputs.formatter == 'black' }}
      shell: bash
      run: |      
        echo "Installing Black"
        python3 -m pip install --upgrade pip
        pip install black 

    - name: Install Golang
      if: ${{ steps.determine-formatter.outputs.formatter == 'gofmt' }}
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'

    # TODO: Add support for foundry/forge later if not a separate action

    - name: Get changed files
      id: changed-files
      shell: bash
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          # Get files changed in PR
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
        else
          # Get files changed in branch compared to default branch
          git fetch origin ${{ github.event.repository.default_branch }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.repository.default_branch }}...HEAD)
        fi
        
        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Run formatter check
      id: format-check
      continue-on-error: true
      shell: bash
      run: |
        set +o pipefail
        chmod +x ${{ github.action_path }}/../../scripts/check-format.sh
        unformatted_files=$(${{ github.action_path }}/../../scripts/check-format.sh \
          "${{ inputs.formatter }}" \
          "${{ inputs.path }}" \
          "${{ inputs.config-file }}" \
          "${{ steps.changed-files.outputs.changed_files }}")
        echo unformatted_files="$unformatted_files" >> $GITHUB_OUTPUT
        echo "::notice::Unformatted files: $unformatted_files"
        if [ -n "$unformatted_files" ]; then
          exit 1
        fi
        set -o pipefail

    - name: Find existing comment
      if: failure() && github.event_name == 'pull_request'
      id: find-comment
      uses: peter-evans/find-comment@v3
      with:
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: 'github-actions[bot]'
        body-includes: '<!-- format-check-comment -->'

    - name: Create or update PR comment
      if: failure() && github.event_name == 'pull_request'
      uses: peter-evans/create-or-update-comment@v4
      with:
        comment-id: ${{ steps.find-comment.outputs.comment-id }}
        issue-number: ${{ github.event.pull_request.number }}
        edit-mode: replace
        body: |
          <!-- format-check-comment -->
          ## ⚠️ Formatting Issues Detected
          
          The following files need formatting with `${{ inputs.formatter }}`:
          
          ${{ steps.format-check.outputs.unformatted_files }}
          
          **Total files:** $(echo -e "${{ steps.format-check.outputs.unformatted_files }}" | grep -v '^$' | wc -l) 
          
          Please run the formatter locally to fix these issues.

    - name: Exit with error if formatting needed
      if: failure()
      shell: bash
      run: |
        echo "Formatting check failed. Files need formatting."
        exit 1

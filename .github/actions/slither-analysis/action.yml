name: On-chain Slither Analysis
description: Runs forge build and slither analysis for on-chain microservices.
inputs:
  CONFIG:
    description: Path to slither config file
    required: false
    default: ./slither.config.json
runs:
  using: "composite"
  steps:
    - name: Prepare environment for Slither
      shell: bash
      run: |
        echo "=== Preparing Foundry project for Slither analysis ==="

        # Create common dependency directories that might be referenced
        mkdir -p lib dependencies node_modules

        # Initialize git submodules if .gitmodules exists
        if [ -f ".gitmodules" ]; then
          echo "→ Initializing git submodules..."
          git submodule update --init --recursive || {
            echo "⚠️  Submodule initialization failed, attempting fallback..."
            git submodule sync
            git submodule update --init --recursive --force || echo "⚠️  Submodule fallback also failed, continuing..."
          }
        fi

        # Debug: Show directory structure
        echo "=== Current directory structure ==="
        ls -la
        echo "=== Looking for Solidity files ==="
        find . -name "*.sol" -type f | head -10 || echo "No .sol files found"
        echo "=== Checking common directories ==="
        for dir in src contracts lib out; do
          if [ -d "$dir" ]; then
            echo "✓ Found directory: $dir"
            find "$dir" -name "*.sol" -type f | wc -l | xargs echo "  - .sol files:"
          else
            echo "✗ Missing directory: $dir"
          fi
        done

        # Check if out directory exists (Foundry's default build output)
        if [ -d "out" ]; then
          echo "✓ Found compiled artifacts in 'out' directory"
          find out -name "*.json" | wc -l | xargs echo "  - Compiled contracts:"
        else
          echo "⚠️  No 'out' directory found - ensure forge build was run previously"
        fi

    - name: Slither Analyze
      id: slither
      uses: crytic/slither-action@v0.4.1
      continue-on-error: true
      with:
        slither-config: ${{ inputs.CONFIG }}
        target: "."
        ignore-compile: true
        # fail-on: pedantic
        # sarif: results.sarif

    # - name: Upload SARIF file
    #   uses: actions/upload-artifact@v4
    #   if: always() && (github.event_name != 'pull_request')
    #   with:
    #     name: results.sarif
    #     path: ${{ steps.slither.outputs.sarif }}
    #     retention-days: 5

    # - name: Slither Analyze Pull Request
    #   id: slither-pull
    #   uses: crytic/slither-action@v0.4.1
    #   if: always() && (github.event_name == 'pull_request')
    #   with:
    #     fail-on: pedantic
    #     slither-args: --checklist --checklist-limit 50 --skip-assembly --markdown-root ${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/

    # - name: Create/update checklist as PR comment
    #   uses: actions/github-script@v7
    #   if: always() && (github.event_name == 'pull_request')
    #   env:
    #     REPORT: ${{ steps.slither-pull.outputs.stdout }}
    #   with:
    #     script: |
    #       const header = '<details><summary>Slither report</summary>\n'
    #       const body = process.env.REPORT + '</details>'
    #       const comment = [header, body].join("\n");

    #       const { data: comments } = await github.rest.issues.listComments({
    #         owner: context.repo.owner,
    #         repo: context.repo.repo,
    #         issue_number: context.payload.number,
    #       });

    #       const botComment = comments.find(
    #         (comment) =>
    #           // github-actions bot user
    #           comment.user.id === 41898282 && comment.body.startsWith(header)
    #       );

    #       const commentFn = botComment ? "updateComment" : "createComment";

    #       await github.rest.issues[commentFn]({
    #         owner: context.repo.owner,
    #         repo: context.repo.repo,
    #         body: comment,
    #         ...(botComment
    #           ? { comment_id: botComment.id }
    #           : { issue_number: context.payload.number }),
    #       });

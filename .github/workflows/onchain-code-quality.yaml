# GitOps On-chain Code Quality Workflow - Callable from remote repositories
# Builds and runs code quality jobs for on-chain projects.
# This workflow is designed to be called from other repositories via 'workflow_call' event.

name: On-chain Code Quality
on:
  # Triggered from app repo's workflows
  workflow_call:
    outputs:
      status:
        description: The status of the deployment job, either 'success', 'failure', or 'skipped'
        value: ${{ jobs.check.result }}
    secrets:
      # Secrets are passed from the calling repository
      ALCHEMY_KEY: # optional, only if needed for tests requiring mainnet fork
        required: false
        description: Alchemy API URI for Ethereum mainnet (for tests requiring mainnet fork)
      POLYGON_ALCHEMY_KEY: # optional, only if needed for tests requiring polygon fork
        required: false
        description: Alchemy API URI for Polygon mainnet (for tests requiring polygon fork)
      # GITHUB_PR_COMMENT_TOKEN:
      #   required: true
      #   description: Token to authenticate on GitHub API, typically provided by the calling workflow


jobs:
  check:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout local repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Checkout infrastructure-tooling repository
        uses: actions/checkout@v4
        with:
          repository: Forte-Service-Company-Ltd/infrastructure-tooling
          ref: v0.0.1
          path: infrastructure-tooling
      - name: Install Foundry
        id: install-foundry
        uses: Forte-Service-Company-Ltd/infrastructure-tooling/.github/actions/install-foundry@v0.0.1
      - name: Install Dependencies
        id: install-dependencies
        uses: Forte-Service-Company-Ltd/infrastructure-tooling/.github/actions/install-dependencies@v0.0.1
      - name: Build
        id: build
        uses: Forte-Service-Company-Ltd/infrastructure-tooling/.github/actions/onchain-build@v0.0.1
      - name: Medusa Fuzz
        id: medusa-fuzz
        uses: Forte-Service-Company-Ltd/infrastructure-tooling/.github/actions/medusa-fuzz@INF-294-Code-Quality-Workflow
      - name: Slither Analysis
        id: slither-analysis
        uses: Forte-Service-Company-Ltd/infrastructure-tooling/.github/actions/slither-analysis@v0.0.1
